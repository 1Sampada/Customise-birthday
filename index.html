<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Birthday Surprise! (New Version) üéÇ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta property="og:title" content="A Birthday Surprise for You!">
    <meta property="og:description" content="Open to see your special card.">
    <meta property="og:type" content="website">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Poppins:wght@400;600;800&family=Gloria+Hallelujah&display=swap"
        rel="stylesheet">

    <style>
        /* --- CORE STYLES --- */
        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            overflow-x: hidden;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            transition: background-image 2s ease, background-color 2s ease;
        }

        /* --- GLASSMOPHISM & UTILS --- */
        .glass-panel {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.1);
        }

        .glass-input {
            background: rgba(255, 255, 255, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(4px);
            transition: all 0.3s ease;
        }

        .glass-input:focus {
            background: rgba(255, 255, 255, 0.9);
            outline: none;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        /* --- SCROLLBAR --- */
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background-color: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }

        /* --- ANIMATIONS --- */
        .fade-in {
            animation: fadeIn 0.8s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        .fade-out {
            animation: fadeOut 0.8s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: scale(1);
            }

            to {
                opacity: 0;
                transform: scale(0.95);
                pointer-events: none;
            }
        }

        canvas#bg-canvas {
            position: fixed;
            inset: 0;
            z-index: 0;
            pointer-events: none;
        }

        /* --- INTERACTIVE ELEMENTS --- */
        .option,
        .rel-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .option:hover,
        .rel-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        /* üî• REMOVE DEFAULT BROWSER FOCUS RING */
        .rel-card:focus,
        .rel-card:focus-visible {
            outline: none !important;
            box-shadow: none !important;
        }

        .rel-card {
            outline: none;
            -webkit-tap-highlight-color: transparent;
            /* Mobile blue flash */
        }

        .option.active,
        .rel-card.active {
            border: 2px solid currentColor;
            background-color: rgba(255, 255, 255, 0.95);
            transform: scale(1.05);
            box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.6);
        }

        .rel-card {
            border: 2px solid transparent;
        }

        /* --- CANDLE ANIMATIONS --- */
        .candle-container {
            position: relative;
            width: 300px;
            height: 300px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .candle-wrapper {
            position: absolute;
            top: -40px;
            display: flex;
            gap: 15px;
            z-index: 20;
        }

        .candle {
            width: 14px;
            height: 70px;
            background: repeating-linear-gradient(45deg, #fcd34d, #fcd34d 5px, #fbbf24 5px, #fbbf24 10px);
            border-radius: 4px;
            position: relative;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .candle::before {
            content: '';
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 2px;
            height: 10px;
            background: #1f2937;
        }

        .flame {
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            width: 18px;
            height: 30px;
            background: radial-gradient(ellipse at center, #ffeb3b 0%, #ff9800 60%, #ff5722 100%);
            border-radius: 50% 50% 20% 20%;
            filter: drop-shadow(0 0 10px rgba(255, 165, 0, 0.6));
            animation: flicker-enhanced 1.5s infinite ease-in-out alternate;
            transform-origin: center bottom;
            z-index: 25;
            opacity: 0.9;
        }

        .flame::after {
            content: '';
            position: absolute;
            bottom: 2px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 12px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            filter: blur(1px);
        }

        .smoke {
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            width: 8px;
            height: 30px;
            background: linear-gradient(to top, rgba(100, 100, 100, 0.5), rgba(100, 100, 100, 0));
            filter: blur(4px);
            opacity: 0;
            transition: opacity 1s;
            border-radius: 50%;
        }

        @keyframes flicker-enhanced {

            0%,
            100% {
                transform: translateX(-50%) scale(1) skewX(0deg);
                opacity: 0.9;
            }

            20% {
                transform: translateX(-50%) scale(1.05) skewX(-2deg);
                opacity: 1;
            }

            40% {
                transform: translateX(-50%) scale(0.95) skewX(2deg);
                opacity: 0.8;
            }

            60% {
                transform: translateX(-50%) scale(1.02) skewX(-1deg);
                opacity: 1;
            }

            80% {
                transform: translateX(-50%) scale(0.98) skewX(1deg);
                opacity: 0.9;
            }
        }

        .blown .flame {
            display: none;
        }

        .blown .smoke {
            opacity: 0.6;
            animation: rise 2.5s forwards ease-out;
        }

        input[type="file"] {
            display: none;
        }

        @keyframes rise {
            from {
                transform: translateX(-50%) translateY(0) scale(1);
            }

            to {
                transform: translateX(-50%) translateY(-80px) scale(2);
                opacity: 0;
            }
        }

        /* --- COLLAGE STYLES --- */
        .handwritten {
            font-family: 'Gloria Hallelujah', cursive;
            outline: none;
            color: #374151;
            line-height: 1.3;
        }

        #collage-board {
            position: relative;
            width: 95vw;
            height: 90vh;
            max-width: 1400px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(12px);
            border-radius: 4rem;
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 50px 100px -30px rgba(0, 0, 0, 0.15) inset;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            /* Desktop: 3 cols */
            gap: 40px;
            padding: 60px 60px 100px 60px;
            overflow-y: auto;
            align-items: center;
            justify-items: center;
        }

        .polaroid {
            background: #ffffff;
            padding: 20px 20px 60px 20px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
            border-radius: 2rem;
            position: relative;
            width: 100%;
            /* Fluid width */
            max-width: 280px;
            /* Cap max width */
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: transform 0.3s ease;
        }

        .polaroid-img {
            background: #f3f4f6;
            width: 100%;
            height: 230px;
            border-radius: 1.5rem;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            border: 2px dashed #d1d5db;
            transition: background 0.3s ease;
        }

        .tape {
            top: -15px;
            left: 50%;
            transform: translateX(-50%) rotate(-1deg);
            width: 90px;
            height: 28px;
            background-color: rgba(255, 255, 255, 0.6);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(4px);
            position: absolute;
            pointer-events: none;
            z-index: 10;
        }

        .clip {
            top: -20px;
            right: 25px;
            width: 20px;
            height: 45px;
            border: 4px solid #9ca3af;
            border-radius: 12px;
            position: absolute;
            pointer-events: none;
            z-index: 10;
        }

        /* --- MOBILE LAYOUT FIX --- */
        @media (max-width: 640px) {
            #collage-board {
                grid-template-columns: repeat(2, 1fr);
                /* 2 columns for mobile */
                gap: 12px;
                /* Smaller gap */
                padding: 20px 15px 100px 15px;
                /* Less padding */
                height: 95vh;
                /* Max height to fit screen */
                align-content: start;
                border-radius: 2rem;
            }

            .polaroid {
                padding: 8px 8px 35px 8px;
                /* Reduce frame padding */
                border-radius: 1rem;
                max-width: none;
                /* Fill grid cell */
                transform: none !important;
                /* Remove rotation to fit grid */
            }

            .polaroid:hover {
                transform: scale(1.02) !important;
            }

            .polaroid-img {
                height: 110px;
                /* Smaller image height */
                border-radius: 0.8rem;
            }

            .handwritten {
                font-size: 0.9rem;
                /* Smaller caption text */
                margin-top: 8px;
            }

            .tape {
                width: 50px;
                height: 15px;
                top: -8px;
            }

            .clip {
                width: 12px;
                height: 25px;
                top: -10px;
                right: 10px;
                border-width: 2px;
            }
        }

        .polaroid-img:hover {
            background-color: #e5e7eb;
            border-color: #9ca3af;
        }

        .polaroid-img img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* --- NOTE STYLES --- */
        .lined-paper {
            background-color: #fffdf5;
            background-image: linear-gradient(#e5e7eb 1px, transparent 1px);
            background-size: 100% 2.5rem;
            line-height: 2.5rem;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
        }

        .paper-stack::before {
            content: '';
            position: absolute;
            top: 5px;
            left: 5px;
            right: -5px;
            bottom: -5px;
            background: white;
            border-radius: 2rem;
            z-index: -1;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            opacity: 0.8;
        }

        .copy-input {
            font-family: monospace;
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
            border-radius: 0.75rem;
        }

        .rel-card * {
            outline: none !important;
            box-shadow: none !important;
        }

        .rel-card:focus,
        .rel-card:focus-visible {
            outline: none !important;
            box-shadow: none !important;
        }

        /* --- CAPTURE CARD STYLES --- */
        #story-capture-container {
            position: fixed;
            top: 0;
            left: -9999px;
            width: 540px;
            height: 960px;
            z-index: -100;
            background: white;
            font-family: 'Poppins', sans-serif;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            padding: 30px;
            box-sizing: border-box;
            align-items: center;
        }

        .story-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            width: 100%;
            margin-bottom: 20px;
        }

        .story-polaroid {
            background: #ffffff;
            padding: 10px 10px 35px 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            transform: rotate(-2deg);
        }

        .story-polaroid:nth-child(even) {
            transform: rotate(2deg);
        }

        .story-polaroid:nth-child(3n) {
            transform: rotate(-1deg) translateY(-5px);
        }

        .story-polaroid img {
            width: 100%;
            height: 140px;
            object-fit: cover;
            border-radius: 8px;
            background-color: #f3f4f6;
        }

        .story-note-paper {
            background-color: #fffdf5;
            background-image: linear-gradient(#e5e7eb 1px, transparent 1px);
            background-size: 100% 1.8rem;
            line-height: 1.8rem;
            padding: 25px;
            width: 95%;
            border-radius: 16px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
            font-family: 'Gloria Hallelujah', cursive;
            font-size: 14px;
            color: #555;
            position: relative;
            flex-grow: 1;
        }

        .washi-tape-top {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%) rotate(-1deg);
            width: 120px;
            height: 25px;
            background: repeating-linear-gradient(45deg, rgba(255, 255, 255, 0.5), rgba(255, 255, 255, 0.5) 10px, rgba(240, 240, 240, 0.6) 10px, rgba(240, 240, 240, 0.6) 20px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            opacity: 0.8;
        }
    </style>
</head>

<body id="mainBody" class="min-h-screen py-10 w-screen flex items-center justify-center bg-gray-100">
    <canvas id="bg-canvas"></canvas>

    <div id="welcome-screen"
        class="hidden glass-panel w-[90vw] max-w-lg p-10 rounded-[3rem] relative z-20 flex flex-col items-center text-center fade-in">
        <div class="mb-6">
            <span class="text-4xl">üëã</span>
            <h1 class="text-3xl font-extrabold text-gray-800 mt-2">Create a Surprise!</h1>
            <p class="text-gray-500 text-sm mt-1">Design a digital birthday experience.</p>
        </div>
        <div class="w-full space-y-6">
            <div class="text-left">
                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2 ml-1">Birthday Person's
                    Name</label>
                <input type="text" id="personName" placeholder="e.g. Sarah"
                    class="glass-input w-full px-5 py-4 rounded-2xl text-lg font-semibold text-gray-700 placeholder-gray-400">
            </div>

            <div class="text-left">
                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2 ml-1">Your Name
                    (Sender)</label>
                <input type="text" id="senderName" placeholder="e.g. Alex"
                    class="glass-input w-full px-5 py-4 rounded-2xl text-lg font-semibold text-gray-700 placeholder-gray-400">
            </div>

            <div class="text-left">
                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2 ml-1">Relationship
                    Context</label>
                <div class="grid grid-cols-3 gap-3">
                    <div onclick="selectRelation('partner', this)"
                        class="rel-card cursor-pointer bg-white/40 p-3 rounded-2xl flex flex-col items-center justify-center gap-2 hover:bg-white text-rose-500">
                        <span class="text-2xl">‚ù§Ô∏è</span><span class="text-xs font-bold text-gray-600">Partner</span>
                    </div>
                    <div onclick="selectRelation('family', this)"
                        class="rel-card cursor-pointer bg-white/40 p-3 rounded-2xl flex flex-col items-center justify-center gap-2 hover:bg-white text-amber-500">
                        <span class="text-2xl">üè°</span><span class="text-xs font-bold text-gray-600">Family</span>
                    </div>
                    <div onclick="selectRelation('friends', this)"
                        class="rel-card cursor-pointer bg-white/40 p-3 rounded-2xl flex flex-col items-center justify-center gap-2 hover:bg-white text-indigo-500">
                        <span class="text-2xl">üéâ</span><span class="text-xs font-bold text-gray-600">Friends</span>
                    </div>
                </div>
            </div>
            <button onclick="enterBuilder()" id="startBtn"
                class="w-full py-4 rounded-2xl bg-gray-800 text-white font-bold text-lg shadow-lg hover:shadow-xl hover:-translate-y-1 transition-all duration-300 opacity-50 cursor-not-allowed"
                disabled>
                Start Designing üé®
            </button>
        </div>
    </div>

    <div id="recipient-screen"
        class="hidden glass-panel w-[90vw] max-w-lg p-12 rounded-[3rem] relative z-20 flex flex-col items-center text-center">
        <div class="mb-8 relative">
            <span class="text-6xl animate-bounce block">üéÅ</span>
        </div>
        <h1 class="text-4xl font-extrabold text-gray-800 mb-2">A Surprise for You!</h1>
        <p class="text-gray-500 mb-8">Someone wrapped a secret birthday gift for you!</p>
        <button onclick="openSurprise()"
            class="px-10 py-4 rounded-2xl bg-gray-800 text-white font-bold text-xl shadow-xl hover:scale-105 transition-transform">
            Open Gift ‚ú®
        </button>
    </div>

    <div id="candle-screen" class="hidden fixed inset-0 z-50 flex flex-col items-center justify-center">
        <div class="glass-panel p-10 rounded-[3rem] flex flex-col items-center animate-in fade-in zoom-in duration-500">
            <h2 class="text-3xl font-extrabold text-gray-800 mb-2">Make a Wish! üéÇ</h2>
            <p id="mic-status" class="text-sm text-gray-500 mb-8">Blow into your microphone to put out the candles!</p>

            <div class="candle-container relative mt-10" onclick="manualBlow()">
                <img id="cake-display" src="" class="w-64 drop-shadow-2xl z-10 relative" alt="Birthday Cake">
                <img id="topping-display" src="" class="absolute bottom-0 left-0 w-36 z-20 drop-shadow-lg"
                    style="display:none" alt="Topping">

                <div class="candle-wrapper" id="candle-holder">
                    <div class="candle">
                        <div class="flame"></div>
                        <div class="smoke"></div>
                    </div>
                    <div class="candle">
                        <div class="flame"></div>
                        <div class="smoke"></div>
                    </div>
                    <div class="candle">
                        <div class="flame"></div>
                        <div class="smoke"></div>
                    </div>
                </div>
            </div>

            <button id="manual-blow-btn" onclick="manualBlow()"
                class="mt-12 text-gray-400 text-xs hover:text-gray-600 underline cursor-pointer hidden">
                (Mic not working? Tap here to blow)
            </button>
        </div>
    </div>

    <div id="builder-screen"
        class="glass-panel w-[90vw] max-w-5xl h-[85vh] rounded-[3rem] flex flex-col md:flex-row relative z-10 overflow-hidden hidden opacity-0">
        <div class="w-full md:w-1/2 p-8 flex flex-col h-full bg-white/40 border-r border-white/50">
            <div class="mb-4">
                <h1 class="text-2xl font-extrabold text-gray-800">Baking for <span id="display-name"
                        class="text-pink-500">Someone</span></h1>
            </div>
            <div class="flex-grow overflow-y-auto custom-scroll pr-2 relative">
                <div id="step1" class="fade-in">
                    <h2 class="text-sm font-bold text-gray-500 uppercase mb-3">1. Flavor Base</h2>
                    <div class="grid grid-cols-3 gap-3 pb-4">
                        <div onclick="selectCake('cake1.png', 'blueberry')"
                            class="option cursor-pointer bg-white p-2 rounded-2xl text-blue-500">
                            <img src="cakes/cake1.png" class="w-full h-auto object-contain" alt="Cake 1">
                            <p class="text-[10px] text-center font-bold mt-1">Blueberry</p>
                        </div>
                        <div onclick="selectCake('cake2.png', 'strawberry')"
                            class="option cursor-pointer bg-white p-2 rounded-2xl text-pink-500">
                            <img src="cakes/cake2.png" class="w-full h-auto object-contain" alt="Cake 2">
                            <p class="text-[10px] text-center font-bold mt-1">Strawberry</p>
                        </div>
                        <div onclick="selectCake('cake3.png', 'mango')"
                            class="option cursor-pointer bg-white p-2 rounded-2xl text-yellow-500">
                            <img src="cakes/cake3.png" class="w-full h-auto object-contain" alt="Cake 3">
                            <p class="text-[10px] text-center font-bold mt-1">Mango</p>
                        </div>
                        <div onclick="selectCake('cake4.png', 'chocolate')"
                            class="option cursor-pointer bg-white p-2 rounded-2xl text-yellow-800">
                            <img src="cakes/cake4.png" class="w-full h-auto object-contain" alt="Cake 4">
                            <p class="text-[10px] text-center font-bold mt-1">Choco</p>
                        </div>
                        <div onclick="selectCake('cake5.png', 'cream')"
                            class="option cursor-pointer bg-white p-2 rounded-2xl text-yellow-800">
                            <img src="cakes/cake5.png" class="w-full h-auto object-contain" alt="Cake 5">
                            <p class="text-[10px] text-center font-bold mt-1">Cream</p>
                        </div>
                        <div onclick="selectCake('cake6.png', 'raspberry')"
                            class="option cursor-pointer bg-white p-2 rounded-2xl text-yellow-800">
                            <img src="cakes/cake6.png" class="w-full h-auto object-contain" alt="Cake 6">
                            <p class="text-[10px] text-center font-bold mt-1">Raspberry</p>
                        </div>
                    </div>
                </div>
                <div id="step2" class="mt-6 fade-in">
                    <h2 class="text-sm font-bold text-gray-500 uppercase mb-3">2. Topping</h2>
                    <div class="grid grid-cols-3 gap-3 pb-4">
                        <div onclick="selectTopping('topping1.png', this)"
                            class="option cursor-pointer bg-white p-2 rounded-2xl text-yellow-800">
                            <img src="toppings/topping1.png" class="w-full h-auto object-contain" alt="Topping 1">
                            <p class="text-[10px] text-center font-bold mt-1">Donuts</p>
                        </div>
                        <div onclick="selectTopping('topping2.png', this)"
                            class="option cursor-pointer bg-white p-2 rounded-2xl text-yellow-800">
                            <img src="toppings/topping2.png" class="w-full h-auto object-contain" alt="Topping 2">
                            <p class="text-[10px] text-center font-bold mt-1">Brownie</p>
                        </div>
                        <div onclick="selectTopping('topping3.png', this)"
                            class="option cursor-pointer bg-white p-2 rounded-2xl text-yellow-800">
                            <img src="toppings/topping3.png" class="w-full h-auto object-contain" alt="Topping 3">
                            <p class="text-[10px] text-center font-bold mt-1">Sundae</p>
                        </div>
                        <div onclick="selectTopping('topping4.png', this)"
                            class="option cursor-pointer bg-white p-2 rounded-2xl text-yellow-800">
                            <img src="toppings/topping4.png" class="w-full h-auto object-contain" alt="Topping 4">
                            <p class="text-[10px] text-center font-bold mt-1">Mini Ice</p>
                        </div>
                        <div onclick="selectTopping('topping5.png', this)"
                            class="option cursor-pointer bg-white p-2 rounded-2xl text-yellow-800">
                            <img src="toppings/topping5.png" class="w-full h-auto object-contain" alt="Topping 5">
                            <p class="text-[10px] text-center font-bold mt-1">CupCake</p>
                        </div>
                        <div onclick="selectTopping('topping6.png', this)"
                            class="option cursor-pointer bg-white p-2 rounded-2xl text-yellow-800">
                            <img src="toppings/topping6.png" class="w-full h-auto object-contain" alt="Topping 6">
                            <p class="text-[10px] text-center font-bold mt-1">Pops</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="pt-4 mt-auto border-t border-gray-200/50 flex justify-end">
                <button onclick="showCollage()"
                    class="px-8 py-3 rounded-2xl bg-gray-800 text-white font-bold shadow-lg hover:shadow-xl hover:-translate-y-1 transition-all">
                    Next Step ‚ûù
                </button>
            </div>
        </div>
        <div class="w-full md:w-1/2 h-full flex flex-col items-center justify-center relative bg-white/20">
            <div class="cake-stage z-20 flex items-center justify-center relative">
                <img id="preview-cake" src="cakes/cake1.png" class="w-64 layer drop-shadow-2xl z-10"
                    alt="Cake Preview" />
                <img id="preview-topping" src="" class="absolute bottom-0 left-0 w-36 z-20 drop-shadow-lg"
                    style="display: none;" alt="Topping Preview" />
            </div>
            <p class="absolute bottom-8 text-xs font-bold tracking-widest opacity-40 uppercase">Live Preview</p>
        </div>
    </div>

    <div id="collage-screen" class="hidden fixed inset-0 z-50 flex items-center justify-center overflow-hidden">
        <div id="collage-board">
            <div class="polaroid">
                <div class="clip"></div>
                <label for="u1" class="polaroid-img cursor-pointer">
                    <input type="file" id="u1" accept="image/*" class="hidden" onchange="previewImage(event,'i1','p1')">

                    <img id="i1" class="hidden" alt="Memory 1">
                    <div id="p1" class="flex flex-col items-center text-gray-300">
                        <span class="text-4xl opacity-50">+</span>
                    </div>
                </label>

                <p id="cap1" class="handwritten text-center mt-3 text-xl" contenteditable="true">Memories</p>
            </div>
            <div class="polaroid">
                <div class="tape"></div>
                <div class="polaroid-img cursor-pointer" onclick="triggerUpload('u2')">
                    <input type="file" id="u2" hidden accept="image/*" onchange="previewImage(event,'i2','p2')">
                    <img id="i2" class="hidden" alt="Memory 2">
                    <div id="p2" class="flex flex-col items-center text-gray-300"><span
                            class="text-4xl opacity-50">+</span></div>
                </div>
                <p id="cap2" class="handwritten text-center mt-3 text-xl" contenteditable="true">Fun Times</p>
            </div>
            <div class="polaroid">
                <div class="tape"></div>
                <div class="polaroid-img cursor-pointer" onclick="triggerUpload('u3')">
                    <input type="file" id="u3" hidden accept="image/*" onchange="previewImage(event,'i3','p3')">
                    <img id="i3" class="hidden" alt="Memory 3">
                    <div id="p3" class="flex flex-col items-center text-gray-300"><span
                            class="text-4xl opacity-50">+</span></div>
                </div>
                <p id="cap3" class="handwritten text-center mt-3 text-xl" contenteditable="true">Smiles</p>
            </div>
            <div class="polaroid">
                <div class="tape"></div>
                <div class="polaroid-img cursor-pointer" onclick="triggerUpload('u4')">
                    <input type="file" id="u4" hidden accept="image/*" onchange="previewImage(event,'i4','p4')">
                    <img id="i4" class="hidden" alt="Memory 4">
                    <div id="p4" class="flex flex-col items-center text-gray-300"><span
                            class="text-4xl opacity-50">+</span></div>
                </div>
                <p id="cap4" class="handwritten text-center mt-3 text-xl" contenteditable="true">The Best</p>
            </div>
            <div class="polaroid">
                <div class="clip"></div>
                <div class="polaroid-img cursor-pointer" onclick="triggerUpload('u5')">
                    <input type="file" id="u5" hidden accept="image/*" onchange="previewImage(event,'i5','p5')">
                    <img id="i5" class="hidden" alt="Memory 5">
                    <div id="p5" class="flex flex-col items-center text-gray-300"><span
                            class="text-4xl opacity-50">+</span></div>
                </div>
                <p id="cap5" class="handwritten text-center mt-3 text-xl" contenteditable="true">Sweet</p>
            </div>
            <div class="polaroid">
                <div class="tape"></div>
                <div class="polaroid-img cursor-pointer" onclick="triggerUpload('u6')">
                    <input type="file" id="u6" hidden accept="image/*" onchange="previewImage(event,'i6','p6')">
                    <img id="i6" class="hidden" alt="Memory 6">
                    <div id="p6" class="flex flex-col items-center text-gray-300"><span
                            class="text-4xl opacity-50">+</span></div>
                </div>
                <p id="cap6" class="handwritten text-center mt-3 text-xl" contenteditable="true">Forever</p>
            </div>
        </div>
        <button id="writeNoteBtn" onclick="showNote()"
            class="fixed bottom-8 right-8 z-50 px-8 py-4 rounded-full bg-white text-gray-800 font-bold shadow-2xl hover:scale-105 transition-transform flex items-center gap-3 border border-gray-100">
            Write Message <span class="text-xl">‚úçÔ∏è</span>
        </button>
    </div>

    <div id="note-screen"
        class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm">
        <div class="paper-stack w-[90vw] max-w-2xl relative">
            <div class="glass-panel lined-paper rounded-[2rem] p-10 relative flex flex-col h-[70vh] md:h-auto">
                <div class="mb-4">
                    <h2 class="handwritten text-3xl font-bold text-gray-800">Dear <span id="note-name"
                            class="text-pink-600">Name</span>,</h2>
                </div>
                <textarea id="final-note"
                    class="w-full flex-grow bg-transparent border-none outline-none handwritten text-xl resize-none custom-scroll text-gray-700"
                    placeholder="Write your birthday wish here..."></textarea>

                <div id="signature-area" class="mt-8 text-right cursor-pointer hidden" onclick="revealSender(this)">
                    <p class="handwritten text-lg text-gray-500">With all my heart,</p>
                    <p id="sender-reveal" class="handwritten text-2xl font-bold text-pink-600 transition-all">
                        ‚Äî Someone who cares ‚ù§Ô∏è<br>
                        <span class="text-xs text-gray-400 font-sans">(click to reveal)</span>
                    </p>
                </div>

                <div class="flex justify-between mt-6 items-end">
                    <div id="download-btn-container" class="hidden">
                        <button onclick="downloadStory()"
                            class="px-6 py-3 rounded-xl bg-pink-500 text-white font-bold shadow-lg hover:bg-pink-600 hover:-translate-y-1 transition-all flex items-center gap-2">
                            <span class="text-lg">üì∏</span> Save Memory Card
                        </button>
                        <p class="text-[10px] text-gray-400 mt-1 ml-1 max-w-[120px] leading-tight">For your Instagram
                            Story!</p>
                    </div>

                    <div id="seal-btn-container">
                        <button onclick="finishAndShare()"
                            class="px-8 py-3 rounded-xl bg-gray-800 text-white font-bold shadow-lg hover:shadow-xl hover:-translate-y-1 transition-all">
                            Seal & Create Link üîó
                        </button>
                    </div>
                </div>
            </div>

            <div id="share-modal"
                class="hidden absolute inset-0 flex flex-col items-center justify-center text-center bg-white/95 rounded-[2rem] p-8 fade-in z-50">
                <span class="text-6xl mb-4">üéâ</span>
                <h2 class="text-3xl font-bold text-gray-800 mb-2">Card Ready!</h2>
                <p class="text-xs text-gray-400 mb-6 max-w-xs mx-auto">Your card is now hidden inside a secret link.</p>

                <div class="w-full mb-4">
                    <label class="text-xs font-bold text-gray-500 uppercase">Copy this Magic Link</label>
                    <div class="flex gap-2 mt-1">
                        <input id="share-link" type="text" readonly class="copy-input w-full p-3 text-sm" value="">
                        <button onclick="copyLink()"
                            class="bg-gray-200 hover:bg-gray-300 px-4 rounded-lg font-bold text-gray-600">Copy</button>
                    </div>
                </div>
                <a id="share-link-anchor" href="#" target="_blank" rel="noopener noreferrer"
                    class="w-full mt-4 px-4 py-4 bg-blue-600 text-white rounded-xl text-center font-bold shadow-lg active:scale-95 transition">
                    üéÅ Tap to Open the Surprise
                </a>
                <a id="wa-btn" href="#" target="_blank"
                    class="w-full py-3 mt-4 rounded-xl bg-green-500 text-white font-bold shadow-md hover:bg-green-600 transition-colors flex items-center justify-center gap-2">
                    <span>Send on WhatsApp</span> üí¨
                </a>
            </div>
        </div>
    </div>

    <div id="story-capture-container">
        <div id="story-bg" class="absolute inset-0 z-0 bg-gradient-to-br from-pink-100 to-white opacity-80"></div>
        <div class="absolute top-0 right-0 p-10 z-0 opacity-20 text-9xl">‚ú®</div>
        <div class="absolute bottom-20 left-10 z-0 opacity-20 text-9xl">üéÇ</div>

        <div class="relative z-10 flex flex-col items-center h-full w-full">
            <div class="text-center mt-4 mb-6">
                <h2 class="font-[Fredoka] text-5xl text-gray-800 mb-2 leading-tight">Happy<br>Birthday!</h2>
                <h3 id="story-name" class="font-['Gloria_Hallelujah'] text-4xl text-pink-500 mt-2">Name</h3>
            </div>

            <div class="story-grid">
                <div id="story-photo-1" class="story-polaroid hidden"><img src="" alt="Story 1">
                    <p class="font-['Gloria_Hallelujah'] text-center mt-2 text-gray-600 text-xs"></p>
                </div>
                <div id="story-photo-2" class="story-polaroid hidden"><img src="" alt="Story 2">
                    <p class="font-['Gloria_Hallelujah'] text-center mt-2 text-gray-600 text-xs"></p>
                </div>
                <div id="story-photo-3" class="story-polaroid hidden"><img src="" alt="Story 3">
                    <p class="font-['Gloria_Hallelujah'] text-center mt-2 text-gray-600 text-xs"></p>
                </div>
                <div id="story-photo-4" class="story-polaroid hidden"><img src="" alt="Story 4">
                    <p class="font-['Gloria_Hallelujah'] text-center mt-2 text-gray-600 text-xs"></p>
                </div>
                <div id="story-photo-5" class="story-polaroid hidden"><img src="" alt="Story 5">
                    <p class="font-['Gloria_Hallelujah'] text-center mt-2 text-gray-600 text-xs"></p>
                </div>
                <div id="story-photo-6" class="story-polaroid hidden"><img src="" alt="Story 6">
                    <p class="font-['Gloria_Hallelujah'] text-center mt-2 text-gray-600 text-xs"></p>
                </div>
            </div>

            <div class="story-note-paper">
                <div class="washi-tape-top"></div>
                <p id="story-note-text" class="text-center">Your lovely birthday message will appear here...</p>
            </div>

            <div class="w-full text-center mt-6 mb-4">
                <p id="story-sender" class="font-bold text-gray-700 text-xl font-['Gloria_Hallelujah']">Love, Sender
                    Name</p>
                <p id="story-date" class="text-gray-500 text-xs mt-1 uppercase tracking-widest"></p>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script>
        // üî• FIREBASE CONFIG (REQUIRED)
        const firebaseConfig = {
            apiKey: "AIzaSyCjJNuY9dFIi2D_Yr0X9Wz_WqbqnV8gFlc",
            authDomain: "links-for-links.firebaseapp.com",
            projectId: "links-for-links",
            appId: "1:289787863708:web:8bf4f555a04550a6000359"
        };

        // üî• FIREBASE INITIALIZATION
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // üî• CLOUDINARY CONFIG - YOU MUST CHANGE THIS!
        // REPLACE "xxxxx" WITH YOUR ACTUAL CLOUDINARY CLOUD NAME
        const CLOUDINARY_CLOUD_NAME = "dehzhyku9";
        const CLOUDINARY_UPLOAD_PRESET = "birthday_unsigned";

        /* --- CONFIGURATION --- */
        const themes = {
            'partner': { bg: 'linear-gradient(135deg, #fecdd3 0%, #f43f5e 100%)', accent: '#e11d48', particles: ['‚ù§Ô∏è', 'üòò', 'üåπ'] },
            'family': { bg: 'linear-gradient(135deg, #fde68a 0%, #f59e0b 100%)', accent: '#d97706', particles: ['üè†', 'üéâ', 'üíõ'] },
            'friends': { bg: 'linear-gradient(135deg, #a5b4fc 0%, #6366f1 100%)', accent: '#4f46e5', particles: ['ü•≥', 'üçª', 'üéà'] }
        };

        /* --- STATE --- */
        let state = {
            name: "",
            sender: "",
            relation: "", // UPDATED: Starts empty
            cake: "cake1.png",
            topping: "",
            photos: [],
            captions: ["Memories", "Fun Times", "Smiles", "The Best", "Sweet", "Forever"],
            note: ""
        };

        let isRecipientMode = false;

        /* --- INIT --- */
        window.onload = () => {
            // üî• HARD RESET ANY AUTO-FOCUS (Chrome bug fix)
            setTimeout(() => {
                if (document.activeElement) {
                    document.activeElement.blur();
                }
            }, 0);
            const urlParams = new URLSearchParams(window.location.search);
            const welcomeScreen = document.getElementById('welcome-screen');

            if (urlParams.has('gift')) {
                // Recipient Mode: Ensure welcome screen is HIDDEN
                isRecipientMode = true;
                welcomeScreen.classList.add('hidden');
                hydrateFromURL(urlParams);
            } else {
                // Sender Mode: Show welcome screen
                resize();
                animate();
                document.body.style.backgroundImage = 'linear-gradient(135deg, #f3f4f6 0%, #d1d5db 100%)';
                updateParticles(['‚ú®', 'üéÇ']);

                // Explicitly show the welcome screen here
                welcomeScreen.classList.remove('hidden');

                // FORCE RESET VISUALS ON LOAD
                // This ensures no old caching issues keep 'friends' selected
                document.querySelectorAll('.rel-card').forEach(c => c.classList.remove('active'));
                state.relation = "";

                // ‚ö†Ô∏è DOUBLE-CHECK FORCE REMOVAL (100ms delay to catch any lingering browser autofill/cache)
                setTimeout(() => {
                    document.getElementById('friends-card').classList.remove('active');
                    state.relation = ""; // Ensure state is reset
                }, 100);

                // Add listeners
                document.getElementById('personName').addEventListener('input', validateStart);
                document.getElementById('senderName').addEventListener('input', validateStart);
            }
        };

        /* --- SENDER FLOW --- */
        function validateStart() {
            const rName = document.getElementById('personName').value.trim();
            const sName = document.getElementById('senderName').value.trim();
            const btn = document.getElementById('startBtn');

            // UPDATED: User MUST select a relation (state.relation !== "")
            if (rName.length > 0 && sName.length > 0 && state.relation !== "") {
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
                state.name = rName;
                state.sender = sName;
            } else {
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        function selectRelation(rel, el) {
            state.relation = rel;
            document.querySelectorAll('.rel-card').forEach(c => c.classList.remove('active'));
            if (el) el.classList.add('active');
            applyTheme(rel);
            validateStart(); // Trigger validation to enable button
        }

        function applyTheme(rel) {
            const t = themes[rel];
            if (!t) return; // Guard clause
            document.body.style.backgroundImage = t.bg;
            const startBtn = document.getElementById('startBtn');
            if (startBtn) startBtn.style.backgroundColor = t.accent;
            updateParticles(t.particles);
        }

        function enterBuilder() {
            document.getElementById('display-name').innerText = state.name;
            document.getElementById('display-name').style.color = themes[state.relation].accent;

            document.getElementById('welcome-screen').classList.add('fade-out');
            setTimeout(() => {
                document.getElementById('welcome-screen').classList.add('hidden');
                document.getElementById('builder-screen').classList.remove('hidden');
                document.getElementById('builder-screen').classList.add('fade-in');
                document.getElementById('builder-screen').style.opacity = "1";
                // Select default cake
                const defaultCake = document.querySelector("#step1 .option");
                if (defaultCake) defaultCake.classList.add('active');
            }, 500);
        }

        function selectCake(img, flavor) {
            state.cake = img;
            document.getElementById('preview-cake').src = `cakes/${img}`;
            document.querySelectorAll('#step1 .option').forEach(o => o.classList.remove('active'));
            if (event.currentTarget) event.currentTarget.classList.add('active');
        }

        function selectTopping(img, el) {
            state.topping = img;
            document.getElementById('preview-topping').src = `toppings/${img}`;
            document.getElementById('preview-topping').style.display = 'block';
            document.querySelectorAll('#step2 .option').forEach(o => o.classList.remove('active'));
            el.classList.add('active');
        }

        function showCollage() {
            document.getElementById('builder-screen').classList.add('fade-out');
            setTimeout(() => {
                document.getElementById('builder-screen').classList.add('hidden');
                document.getElementById('collage-screen').classList.remove('hidden');
                document.getElementById('collage-screen').classList.add('fade-in');
            }, 600);
        }
        /* --- HELPER FOR UPLOADS --- */
        function triggerUpload(inputId) {
            const fileInput = document.getElementById(inputId);

            // Prevent the click from bubbling back up to the parent div
            // effectively stopping an infinite loop
            fileInput.onclick = function (e) {
                e.stopPropagation();
            }

            fileInput.click();
        }
        async function previewImage(e, imgId, placeholderId) {
            const file = e.target.files[0];
            if (!file) return;

            if (file.size > 5 * 1024 * 1024) {
                alert("Please upload images under 5MB üíõ");
                return;
            }

            const index = parseInt(imgId.replace("i", "")) - 1;
            const formData = new FormData();
            formData.append("file", file);
            formData.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);
            formData.append("folder", "birthday-cards");

            try {
                const res = await fetch(
                    `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`,
                    { method: "POST", body: formData }
                );
                const data = await res.json();

                if (data.error) {
                    alert("Upload failed. Check Cloud Name.");
                    return;
                }

                // Optimized mobile-friendly image
                const imageURL = data.secure_url.replace("/upload/", "/upload/q_auto,f_auto,w_900/");

                document.getElementById(imgId).src = imageURL;
                document.getElementById(imgId).classList.remove("hidden");
                document.getElementById(placeholderId).classList.add("hidden");

                state.photos[index] = imageURL;
            } catch (err) {
                console.error(err);
                alert("Upload error.");
            }
        }

        function showNote() {
            document.getElementById('collage-screen').classList.add('fade-out');
            setTimeout(() => {
                document.getElementById('collage-screen').classList.add('hidden');
                document.getElementById('note-screen').classList.remove('hidden');
                document.getElementById('note-screen').classList.add('fade-in');
                document.getElementById('note-name').innerText = state.name;
                document.getElementById('note-name').style.color = themes[state.relation].accent;
            }, 600);
        }

        /* --- FINALIZING & SHARING --- */
        async function finishAndShare() {
            state.note = document.getElementById('final-note').value;

            try {
                const docRef = await db.collection("cards").add({
                    name: state.name,
                    sender: state.sender,
                    relation: state.relation,
                    cake: state.cake,
                    topping: state.topping,
                    photos: state.photos,
                    captions: state.captions,
                    note: state.note,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                const shareURL = `${location.origin}${location.pathname}?gift=${docRef.id}`;
                document.getElementById('share-link').value = shareURL;
                document.getElementById('share-link-anchor').href = shareURL;
                document.getElementById('wa-btn').href = `https://wa.me/?text=${encodeURIComponent("I made something special for you üéÅ " + shareURL)}`;

                document.getElementById('share-modal').classList.remove('hidden');
                document.getElementById('seal-btn-container').classList.add('hidden');
                confetti({ particleCount: 150, spread: 90 });
            } catch (err) {
                console.error("Firebase write error:", err);
                alert("Could not save card. Check console/config.");
            }
        }

        function copyLink() {
            const copyText = document.getElementById("share-link");
            copyText.select();
            document.execCommand("copy");
            alert("Magic link copied! Send it to the birthday star!");
        }

        /* --- RECIPIENT FLOW --- */
        async function hydrateFromURL(params) {
            const id = params.get('gift');
            if (!id) return;

            try {
                const doc = await db.collection("cards").doc(id).get();
                if (!doc.exists) {
                    alert("This surprise no longer exists üò¢");
                    return;
                }

                const data = doc.data();
                state.name = data.name;
                state.sender = data.sender;
                state.relation = data.relation;
                state.cake = data.cake;
                state.topping = data.topping;
                state.photos = data.photos || [];
                state.captions = data.captions || [];
                state.note = data.note || "";

                resize();
                animate();
                applyTheme(state.relation);
                document.getElementById('cake-display').src = `cakes/${state.cake}`;
                if (state.topping) {
                    document.getElementById('topping-display').src = `toppings/${state.topping}`;
                    document.getElementById('topping-display').style.display = 'block';
                }

                document.getElementById('recipient-screen').classList.remove('hidden');
            } catch (err) {
                console.error(err);
            }
        }

        function openSurprise() {
            document.getElementById('recipient-screen').classList.add('fade-out');
            setTimeout(() => {
                document.getElementById('recipient-screen').classList.add('hidden');
                document.getElementById('candle-screen').classList.remove('hidden');
                startAudioDetection();
            }, 600);
        }

        /* --- AUDIO DETECTION --- */
        let audioContext;
        let analyser;
        let blown = false;

        async function startAudioDetection() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                const microphone = audioContext.createMediaStreamSource(stream);
                microphone.connect(analyser);
                analyser.fftSize = 256;
                const bufferLength = analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);

                // Show manual button after 5 seconds
                setTimeout(() => {
                    document.getElementById('manual-blow-btn').classList.remove('hidden');
                }, 5000);

                function detectBlow() {
                    if (blown) return;
                    analyser.getByteFrequencyData(dataArray);
                    let sum = 0;
                    for (let i = 0; i < bufferLength; i++) { sum += dataArray[i]; }
                    let average = sum / bufferLength;

                    if (average > 45) { // Sensitivity
                        manualBlow();
                    }
                    requestAnimationFrame(detectBlow);
                }
                detectBlow();
            } catch (err) {
                console.log("Mic access error:", err);
                document.getElementById('mic-status').innerText = "Mic disabled. Tap the candles to blow them out!";
                document.getElementById('manual-blow-btn').classList.remove('hidden');
            }
        }

        function manualBlow() {
            if (blown) return;
            blown = true;

            const candles = document.querySelectorAll('.candle');
            candles.forEach(c => c.classList.add('blown'));

            if (audioContext && audioContext.state !== 'closed') audioContext.close();

            document.getElementById('mic-status').innerText = "Yay! Wishes made! ‚ú®";
            confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 } });

            setTimeout(() => { goToCollage(); }, 2500);
        }

        function goToCollage() {
            document.getElementById('candle-screen').classList.add('fade-out');

            for (let i = 1; i <= 6; i++) {
                if (state.captions[i - 1]) document.getElementById(`cap${i}`).innerText = state.captions[i - 1];
                document.getElementById(`cap${i}`).contentEditable = "false";
                document.getElementById(`u${i}`).disabled = true;
                // Remove pointer events to prevent clicking
                document.querySelector(`#u${i}`).parentElement.removeAttribute('onclick');
                document.querySelector(`#u${i}`).parentElement.classList.remove('cursor-pointer');

                if (state.photos[i - 1]) {
                    document.getElementById(`i${i}`).src = state.photos[i - 1];
                    document.getElementById(`i${i}`).classList.remove('hidden');
                    document.getElementById(`p${i}`).classList.add('hidden');
                }
            }

            document.getElementById('writeNoteBtn').innerText = "Read Message üíå";
            document.getElementById('writeNoteBtn').onclick = readNote;

            setTimeout(() => {
                document.getElementById('candle-screen').classList.add('hidden');
                document.getElementById('collage-screen').classList.remove('hidden');
                document.getElementById('collage-screen').classList.add('fade-in');
            }, 600);
        }

        function readNote() {
            document.getElementById('collage-screen').classList.add('fade-out');
            document.getElementById('note-name').innerText = state.name;
            document.getElementById('note-name').style.color = themes[state.relation].accent;
            document.getElementById('final-note').value = state.note;
            document.getElementById('final-note').readOnly = true;

            document.getElementById('seal-btn-container').style.display = 'none';
            document.getElementById('signature-area').style.display = 'block';
            document.getElementById('download-btn-container').classList.remove('hidden');

            setTimeout(() => {
                document.getElementById('collage-screen').classList.add('hidden');
                document.getElementById('note-screen').classList.remove('hidden');
                document.getElementById('note-screen').classList.add('fade-in');
            }, 600);
        }

        function revealSender(el) {
            const name = state.sender || "A Secret Friend";
            const textEl = document.getElementById('sender-reveal');
            textEl.innerHTML = `‚Äî ${name} üíñ`;
            textEl.classList.add('scale-110');
            setTimeout(() => textEl.classList.remove('scale-110'), 200);
            confetti({ particleCount: 30, spread: 50, origin: { y: 0.8 }, colors: [themes[state.relation].accent] });
        }

        /* --- DOWNLOAD MEMORY CARD --- */
        function downloadStory() {
            document.getElementById('story-name').innerText = state.name;
            document.getElementById('story-sender').innerText = `Love, ${state.sender || 'A Secret Friend'}`;
            document.getElementById('story-note-text').innerText = state.note || "Happy Birthday! üéâ";

            const today = new Date();
            document.getElementById('story-date').innerText = today.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

            const theme = themes[state.relation];
            document.getElementById('story-name').style.color = theme.accent;
            document.getElementById('story-bg').style.background = theme.bg;

            for (let i = 1; i <= 6; i++) {
                const photoEl = document.getElementById(`story-photo-${i}`);
                const img = state.photos[i - 1];
                const caption = state.captions[i - 1];

                if (img) {
                    photoEl.querySelector('img').src = img;
                    photoEl.querySelector('p').innerText = caption || "";
                    photoEl.classList.remove('hidden');
                } else {
                    photoEl.classList.add('hidden');
                }
            }

            const captureElement = document.getElementById('story-capture-container');

            html2canvas(captureElement, { scale: 2, useCORS: true, allowTaint: true, backgroundColor: null }).then(canvas => {
                const link = document.createElement('a');
                link.download = `Birthday-Memory-${state.name}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            }).catch(err => {
                console.error("Capture failed:", err);
                alert("Oops! Could not save the image. Try taking a screenshot instead!");
            });
        }

        /* --- BACKGROUND PARTICLES --- */
        const canvas = document.getElementById('bg-canvas');
        const ctx = canvas.getContext('2d');
        let particles = [];

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);

        class Particle {
            constructor(emojiList) {
                this.x = Math.random() * canvas.width;
                this.y = canvas.height + Math.random() * 100;
                this.speed = 0.5 + Math.random();
                this.size = 15 + Math.random() * 20;
                this.text = emojiList[Math.floor(Math.random() * emojiList.length)];
            }
            update() {
                this.y -= this.speed;
                if (this.y < -50) {
                    this.y = canvas.height + 50;
                    this.x = Math.random() * canvas.width;
                }
            }
            draw() {
                ctx.font = `${this.size}px Arial`;
                ctx.globalAlpha = 0.5;
                ctx.fillText(this.text, this.x, this.y);
                ctx.globalAlpha = 1.0;
            }
        }

        function updateParticles(emojiList) {
            particles = [];
            for (let i = 0; i < 25; i++) particles.push(new Particle(emojiList));
        }

        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles.forEach(p => { p.update(); p.draw(); });
            requestAnimationFrame(animate);
        }
    </script>
</body>

</html>